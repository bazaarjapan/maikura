# 要件定義書（Block World）

## 1. 目的とスコープ
- ブラウザ上で動作するマインクラフトライクなサンドボックスゲームを実装する。
- 現状（地形生成・WASD移動・ジャンプ・ブロック設置/破壊）を基礎に、段階的に本格機能へ拡張する。

## 2. 対象プラットフォーム / 前提
- 対象: デスクトップ最新ブラウザ（Chrome/Edge/Firefox, WebGL2 有効）。
- 非対象: モバイル・タブレット（初期段階）。
- 技術前提: Vite + TypeScript、Three.js は CDN（r128 以降を固定）、Pointer Lock は HTTPS 前提。

## 3. 画面/操作要件（現状ベース）
- 画面: フルスクリーン 3D 表示、中央クロスヘア、開始インストラクション（クリックでロック）。
- 操作: WASD 移動、Space ジャンプ、マウス視点、左クリック=破壊、右クリック=設置、射程8m。

## 4. 機能要件（段階別）
### MVP（現状→安定化）
- チャンク化: 16×16×H（H=128 目安）。チャンク単位で生成/破棄。
- メッシング最適化: InstancedMesh または Greedy Meshing 採用。
- ワールド種: `seed` 固定で再現可能な高さ関数（sin/cos → Simplex へ移行準備）。
- 保存: 変更差分（壊した/置いたブロック）を IndexedDB に保存/復元。
- UI: FPS/座標/ヘルプ（H）の簡易HUD。

### Alpha
- ブロック種拡張: 草・土・石・木・葉・砂・水（流体は静的表現から）。
- 道具: 簡易インベントリ（1〜9 キーのホットバー）。
- 当たり判定: AABB でプレイヤー/ブロック衝突の安定化、階段相当の段差処理。
- ワールド境界: 無限風（チャンク遅延生成）と落下リカバリ。

### Beta
- ライティング: 昼夜サイクル、太陽光の方向変化、簡易ブロック光源。
- 音: 足音/破壊/設置の SE、BGM オプション。
- セーブスロット: 複数ワールド管理（seed + 設定）。

### 1.0
- バイオーム: 平原/森林/砂漠/雪原（色/ブロック分布/高度関数）。
- 生物（任意）: 非NPC の徘徊と当たり判定のみ。
- 設定メニュー: マウス感度、描画距離、DPR 上限、音量。

## 5. 非機能要件
- パフォーマンス: フルHD・DPR≤2・描画距離8チャンクで 60fps 目標（最低 30fps）。
- 起動時間: 初回ロード < 3s（HTTP/2, CDN）。
- メモリ: 実メッシュ/インスタンスを 150k 面以下に抑制（同条件時）。
- アクセシビリティ: キー操作リマップ（後続）、感度調整、被写界深度等の過剰効果は未使用。
- 国際化: 表示テキストは i18n 対応（ja/en）。

## 6. データ要件
- ブロックID: 整数（0=空気, 1=草, 2=土, …）。
- チャンク座標: 整数 (cx, cy, cz)。ワールド座標→チャンク内座標へ変換。
- 保存形式: `world:{seed}:{cx}:{cz}` キーで差分を IndexedDB に格納（RLE などで圧縮可）。
- 設定: `settings.json`（DPR 上限/描画距離/感度）。

## 7. 技術要件
- レンダリング: Three.js、InstancedMesh/合成メッシュ、フォグ、シャドウはプレイヤー周辺限定。
- 並列化: Per-chunk 生成/メッシングを Web Worker 化。
- 入力: PointerLockControls 派生（移動・ジャンプ・リマップ可能なキーバインド）。

## 8. 品質保証 / 受け入れ基準
- スモーク: シーン起動・ポインターロック・WASD/ジャンプが例外を出さない（Vitest）。
- 機能: ブロック設置/破壊が 100 回連続で整合（座標誤差 ±0.01 未満）。
- パフォーマンス: テストマップで 60fps±10 を 5 分維持、GC スパイク < 50ms。
- 保存: 再読み込みで直前の変更が完全再現。

## 9. リスクと制約
- CDN 障害リスク（対策: バージョン固定/自己ホスト fallback）。
- Pointer Lock は HTTPS 必須（プレビュー時はローカル許可）。
- モバイルは対応外（WebGL/入力/UI 再設計が必要）。

## 10. マイルストーン（目安）
- M0: MVP 安定化（チャンク化/保存/UI）
- M1: Alpha（ブロック種/インベントリ/当たり判定）
- M2: Beta（昼夜・音・セーブスロット）
- M3: 1.0（バイオーム/設定/最適化仕上げ）